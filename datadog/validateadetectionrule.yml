apiVersion: backstage.io/v1alpha1
kind: API
metadata:
  name: Validate A Detection Rule
  description: Validate a detection rule.
  tags: []
  links:
    - title: Link
      icon: code
      url: https://example.com
spec:
  type: openapi
  lifecycle: experimental
  owner: team-c
  definition: |
    openapi: 3.1.0
    info:
      title: Validate A Detection Rule
      description: Validate a detection rule.
    paths:
      /api/v2/security_monitoring/rules/validation:
        post:
          summary: Validate A Detection Rule
          description: Validate a detection rule.
          operationId: validateadetectionrule
          requestBody:
            content:
              application/json:
                schema:
                  type: object
                  example:
                    name: My security monitoring rule.
                    isEnabled: true
                    queries: []
                    options:
                      complianceRuleOptions:
                        complexRule: true
                        regoRule:
                          policy: |
                            package datadog

                            import data.datadog.output as dd_output
                            import future.keywords.contains
                            import future.keywords.if
                            import future.keywords.in

                            eval(resource) = "skip" if {
                              # Logic that evaluates to true if the resource should be skipped
                              true
                            } else = "pass" {
                              # Logic that evaluates to true if the resource is compliant
                              true
                            } else = "fail" {
                              # Logic that evaluates to true if the resource is not compliant
                              true
                            }

                            # This part remains unchanged for all rules
                            results contains result if {
                              some resource in input.resources[input.main_resource_type]
                              result := dd_output.format(resource, eval(resource))
                            }
                          resourceTypes:
                            - gcp_iam_service_account
                            - gcp_iam_policy
                        resourceType: aws_acm
                      decreaseCriticalityBasedOnEnv: false
                      detectionMethod: hardcoded
                      evaluationWindow: 7200
                      hardcodedEvaluatorType: log4shell
                      impossibleTravelOptions:
                        baselineUserLocations: true
                      keepAlive: 0
                      maxSignalDuration: 1800
                      newValueOptions:
                        forgetAfter: 14
                        learningDuration: 0
                        learningMethod: duration
                        learningThreshold: 0
                      thirdPartyRuleOptions:
                        defaultNotifications:
                          - Lo
                          - est ut sunt
                        defaultStatus: critical
                        rootQueries:
                          - groupByFields:
                              - non do Duis irure in
                              - velit dolore in
                            query: source:cloudtrail
                          - groupByFields:
                              - eiusmod labore nostrud
                              - aliqua enim adipisicing
                            query: source:cloudtrail
                        signalTitleTemplate: et
                    cases: []
                    message: ''
                    filters:
                      - action: suppress
                        query: sunt
                      - action: require
                        query: qui culpa sunt et
                    hasExtendedTitle: true
                    tags:
                      - env:prod
                      - team:security
                    type: workload_security
          responses:
            '429':
              description: Too Many Requests
              headers:
                Content-Type:
                  schema:
                    type: string
                    example: application/json
              content:
                application/json:
                  schema:
                    type: object
                  example:
                    errors:
                      - Bad Request
                      - Bad Request
